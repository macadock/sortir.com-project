{% extends 'base.html.twig' %}

{% block title %}
    Modifier une sortie | {{ parent() }}

{% endblock %}

{% block body %}
    <div class="flex w-full items-center justify-center">
        <div class="mt-5 w-2/3 mx-auto">
            <div class="bg-gray-200 flex-col p-4 border rounded-xl mt-5">
                <h1 class="text-3xl">Modifier une sortie</h1>

                {{ form_start(sortieForm) }}

                <div class="flex flex-wrap">
                    <div class="w-1/2 p-2 items-start">
                        <div class="flex items-center my-2">
                            <div class="px-2 text-red-800">
                                {{ form_errors(sortieForm.nom) }}
                            </div>
                        </div>
                        <div class="flex items-center my-2">
                            <div class=" px-2 mb-1 w-1/3">
                                {{ form_label(sortieForm.nom) }}
                            </div>
                            {{ form_widget(sortieForm.nom, {'attr': {'class':'w-2/3 block rounded-xl p-2 h-8'}}) }}
                        </div>
                        <div class="flex items-center my-2">
                            <div class="px-2 text-red-800">
                                {{ form_errors(sortieForm.dateHeureDebut) }}
                            </div>
                        </div>
                        <div class="flex items-center my-2">
                            <div class=" px-2 mb-1 w-1/3">
                                {{ form_label(sortieForm.dateHeureDebut) }}
                            </div>
                            {{ form_widget(sortieForm.dateHeureDebut, {'attr': {'class':'w-2/3 block rounded-xl p-2 h-8'}}) }}
                        </div>
                        <div class="flex items-center my-2">
                            <div class="px-2 text-red-800">
                                {{ form_errors(sortieForm.dateLimiteInscription) }}
                            </div>
                        </div>
                        <div class="flex items-center my-2">
                            <div class=" px-2 mb-1 w-1/3">
                                {{ form_label(sortieForm.dateLimiteInscription) }}
                            </div>
                            {{ form_widget(sortieForm.dateLimiteInscription, {'attr': {'class':'w-2/3 block rounded-xl p-2 h-8'}}) }}
                        </div>
                        <div class="flex items-center my-2">
                            <div class="px-2 text-red-800">
                                {{ form_errors(sortieForm.nbInscriptionsMax) }}
                            </div>
                        </div>
                        <div class="flex items-center my-2">
                            <div class=" px-2 mb-1 w-1/3">
                                {{ form_label(sortieForm.nbInscriptionsMax) }}
                            </div>
                            {{ form_widget(sortieForm.nbInscriptionsMax, {'attr': {'class':'w-2/3 block rounded-xl p-2 h-8'}}) }}
                        </div>
                        <div class="flex items-center my-2">
                            <div class="px-2 text-red-800">
                                {{ form_errors(sortieForm.duree) }}
                            </div>
                        </div>
                        <div class="flex items-center my-2">
                            <div class=" px-2 mb-1 w-1/3">
                                {{ form_label(sortieForm.duree) }}
                            </div>
                            {{ form_widget(sortieForm.duree, {'attr': {'class':'w-2/3 block rounded-xl p-2 h-8'}}) }}
                        </div>
                        <div class="flex items-center my-2">
                            <div class="px-2 text-red-800">
                                {{ form_errors(sortieForm.infos) }}
                            </div>
                        </div>
                        <div class="flex items-start my-2">
                            <div class=" px-2 mb-1 w-1/3">
                                {{ form_label(sortieForm.infos) }}
                            </div>
                            {{ form_widget(sortieForm.infos, {'attr': {'class':'w-2/3 block rounded-xl p-2 h-20'}}) }}
                        </div>

                    </div>
                    <div class="flex items-center my-2">
                        <div class="px-2 text-red-800">
                            {{ form_errors(sortieForm.campusOrganisateur) }}
                        </div>
                    </div>
                    <div class="w-1/2 p-2 items-baseline">
                        <div class="flex items-center my-2">
                            <div class=" px-2 mb-1 w-1/3">
                                {{ form_label(sortieForm.campusOrganisateur) }}
                            </div>
                            {{ form_widget(sortieForm.campusOrganisateur, {'attr': {'class':'w-2/3 block rounded-xl p-2 h-8 appearance-none disabled'}}) }}
                        </div>
                        <div class="flex items-center my-2">
                            <div class="px-2 text-red-800">
                                {{ form_errors(sortieForm.ville) }}
                            </div>
                        </div>
                        <div class="flex items-baseline my-2">
                            <div class=" px-2 mb-1 w-1/3">
                                {{ form_label(sortieForm.ville) }}
                            </div>
                            {{ form_widget(sortieForm.ville, {'attr': {'class':'w-2/3 block rounded-xl p-2 h-8'}}) }}
                        </div>
                        <div class="flex items-center my-2">
                            <div class="px-2 text-red-800">
                                {{ form_errors(sortieForm.lieu) }}
                            </div>
                        </div>
                        <div class="flex items-baseline my-2">
                            <div class="flex justify-between px-2 mb-1 w-1/3">
                                {{ form_label(sortieForm.lieu) }}
                                <a class="text-black cursor-pointer" id="ajouter_lieu">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                </a>
                            </div>
                            {{ form_widget(sortieForm.lieu, {'attr': {'class':'w-2/3 block rounded-xl p-2 h-8'}}) }}
                        </div>
                        <div class="flex items-center my-2">
                            <div class=" px-2 mb-1 w-1/3">
                                Rue
                            </div>
                            <div class="w-2/3 pl-2" id="rue_default">

                            </div>
                        </div>
                        <div class="flex items-baseline my-2">
                            <div class=" px-2 mb-1 w-1/3">
                                Code postal
                            </div>
                            <div class="w-2/3 pl-2" id="code_postal_default">

                            </div>

                        </div>
                        <div class="flex items-center my-2">
                            <div class=" px-2 mb-1 w-1/3">
                                Latitude
                            </div>
                            <div class="w-2/3 pl-2" id="latitude_default">

                            </div>
                        </div>
                        <div class="flex items-center my-2">
                            <div class=" px-2 mb-1 w-1/3">
                                Longitude
                            </div>
                            <div class="w-2/3 pl-2" id="longitude_default">

                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex w-full mx-auto justify-center">
                    <div class="p-2">
                        {{ form_widget(sortieForm.save, {'attr': {'class':'bg-gray-500 rounded-md p-3 px-6 text-white'}}) }}
                    </div>
                    <div class="p-2">
                        {{ form_widget(sortieForm.publish, {'attr': {'class':'bg-gray-500 rounded-md p-3 px-6 text-white'}}) }}
                    </div>
                    <div class="p-2">
                        <a href="{{ path('sortie_afficher', {'id': id}) }}">
                            <button class="bg-gray-500 rounded-md p-3 px-6 text-white" type="button">
                                Annuler
                            </button>
                        </a>

                    </div>
                </div>

                {{ form_end(sortieForm) }}
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        const apiUrl = '/api/';
        const idLieuFormulaire = 'sortie_lieu';
        const idBoutonAjoutLieu = 'ajouter_lieu';
        const idFormClose = 'form_close';
        const idVilleForm = 'sortie_ville';
        const idModaleAjoutLieu = 'form_ajouter_lieu';
        const idSelectNouvelleVille = 'select_nouvelle_ville';
        const idFormAjoutLieu = 'ajout_lieu';

        const ajoutLieu = document.getElementById(idBoutonAjoutLieu);
        ajoutLieu.addEventListener('click', afficherFormAjoutLieu);

        const fermerModale = document.getElementById(idFormClose);
        fermerModale.addEventListener('click', masquerFormAjoutLieu);

        const ville = document.getElementById(idVilleForm);
        ville.addEventListener('change', chargerLieux);

        const lieu = document.getElementById(idLieuFormulaire);
        lieu.addEventListener('change', chargerInfosLieu);

        const formModalAjoutLieu = document.getElementById(idModaleAjoutLieu);

        const formAjoutLieu = document.getElementById(idFormAjoutLieu);

        const form = document.forms[idFormAjoutLieu];

        let idLieu = null;

        formAjoutLieu.addEventListener('submit', function (event) {
            event.preventDefault();
            const data = new URLSearchParams();
            data.append('nom', form.elements["nom"].value);
            data.append('rue', form.elements["rue"].value);
            data.append('ville', form.elements["ville"].value);
            data.append('latitude', form.elements["latitude"].value);
            data.append('longitude', form.elements["longitude"].value);

            const idVille = form.elements["ville"].value;

            fetch(apiUrl+'lieu/create', {
                method: 'POST',
                body: data,
            })
                .then(response => response.json())
                .then(lieuCree => {
                    masquerFormAjoutLieu();
                    ville.value = idVille;
                    idLieu = lieuCree.id;
                    chargerLieux();
                })
        });

        function afficherFormAjoutLieu() {
            chargerVilles()
            formModalAjoutLieu.classList.remove('hidden');
            formModalAjoutLieu.classList.add('block');
        }

        function masquerFormAjoutLieu() {
            formModalAjoutLieu.classList.remove('block');
            formModalAjoutLieu.classList.add('hidden');
            form.reset();
        }

        function chargerVilles() {
            fetch(apiUrl+'villes')
                .then(response => response.json())
                .then(villes => {
                    supprimerLieux(idSelectNouvelleVille);

                    for (const ville of villes) {

                        const option = document.createElement('option');
                        option.textContent = ville.nom;
                        option.value = ville.id;
                        document.getElementById(idSelectNouvelleVille).appendChild(option);
                    }
                    if (idLieu != null) {
                        lieu.value = idLieu;
                        idLieu = null;
                    }

                })
        }


        function supprimerLieux(selectToRemoveChild) {
            let nbLieux = document.getElementById(selectToRemoveChild).childElementCount;
            for (let i = 0; i < nbLieux - 1; i++) {
                document.getElementById(selectToRemoveChild).lastElementChild.remove();
            }
        }

        function chargerLieux() {

            fetch(apiUrl+ville.value+'/lieux')
                .then(response => response.json())
                .then(lieux => {
                    supprimerLieux(idLieuFormulaire);

                    for (const lieu of lieux) {
                        document.getElementById('rue').textContent = '';
                        document.getElementById('latitude').textContent = '';
                        document.getElementById('longitude').textContent = '';

                        const option = document.createElement('option');
                        option.textContent = lieu.nom;
                        option.value = lieu.id;
                        document.getElementById(idLieuFormulaire).appendChild(option);
                    }
                } )
        }

        function chargerInfosLieu() {
            const idLieu = lieu.value;

            fetch(apiUrl+'lieu/infos/'+idLieu)
                .then(response => response.json())
                .then(infosLieu => {

                    document.getElementById('rue_default').innerHTML = infosLieu[0].rue;
                    document.getElementById('code_postal_default').innerHTML = infosLieu[1].code_postal;

                    if (infosLieu[0].latitude != null) {
                        document.getElementById('latitude_default').innerHTML = infosLieu[0].latitude;
                    } else {
                        document.getElementById('latitude_default').innerHTML = "Non défini";
                    }

                    if (infosLieu[0].longitude != null) {
                        document.getElementById('longitude_default').innerHTML = infosLieu[0].longitude;
                    } else {
                        document.getElementById('longitude_default').innerHTML = "Non défini";
                    }
                })
                .catch()

        }

        window.onload = chargerInfosLieu();

    </script>
{% endblock %}



